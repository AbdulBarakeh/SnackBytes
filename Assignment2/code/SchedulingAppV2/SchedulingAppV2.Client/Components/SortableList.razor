@using System.Collections.Generic
@using System.Diagnostics.CodeAnalysis
@using SchedulingApp.Shared.Models
@using System.Text.RegularExpressions
@using SchedulingApp.Shared.Services
@inject IJSRuntime JS

@typeparam T

<div id="@Id">
    @foreach (var item in Items)
    {
        @if (SortableItemTemplate is not null)
        {
            @SortableItemTemplate(item)
        }
    }
</div>

@code {
    [Inject]
    public SchedulingApp.Shared.Services.ISchedulingService ScheduleService { get; set; }

    [Parameter]
    public RenderFragment<T>? SortableItemTemplate { get; set; }

    [Parameter, AllowNull]
    public List<T> Items { get; set; }

    [Parameter]
    public EventCallback<(int oldIndex, int newIndex, string content)> OnRemove { get; set; }

    [Parameter]
    public string Id { get; set; } = Guid.NewGuid().ToString();

    [Parameter]
    public string Group { get; set; } = Guid.NewGuid().ToString();

    [Parameter]
    public string? Pull { get; set; }

    [Parameter]
    public bool Put { get; set; } = true;

    [Parameter]
    public bool Sort { get; set; } = true;

    [Parameter]
    public string Handle { get; set; } = string.Empty;

    [Parameter]
    public string? Filter { get; set; }

    private DotNetObjectReference<SortableList<T>>? selfReference;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            selfReference = DotNetObjectReference.Create(this);
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./Components/SortableList.razor.js");
            await module.InvokeAsync<string>("init", Id, Group, Pull, Put, Sort, Handle, Filter, selfReference);
        }
    }


    [JSInvokable]
    public void OnRemoveJS(int oldIndex, int newIndex, string content)
    {
        // remove the item from the list
        OnRemove.InvokeAsync((oldIndex, newIndex, content));
    }

    [JSInvokable]
    public void UpdateCustomDotNetList(string target, string source)
    {
        foreach (SchedulingInfo item in ScheduleService.Schedulings)
        {
            if (item.Guid.ToString() == source)
            {
                var regex = new Regex("\\d+/\\d+/\\d+");
                item.Date = DateTime.Parse(regex.Match(target).Value);
            }
        }
        ShouldRender();
    }

    public void Dispose() => selfReference?.Dispose();
}
